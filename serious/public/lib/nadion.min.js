/*! Nadion v0.2.0 | (c) 2013 Joshua C Shepard */
"use strict";var Phaser=Phaser||window.Phaser||null,Nadion=Nadion||{name:"nadionBasedGame",VIEW_WIDTH:640,VIEW_HEIGHT:480,go:function(a){var b,c=Phaser.AUTO,d=location.search.substring(1).split("&");for(var e in d){var f=d[e].split("=");f.length>1&&"render"===decodeURIComponent(f[0])&&(b=decodeURIComponent(f[1].replace(/\+/g," ")))}"string"==typeof b&&"canvas"===b&&(c=Phaser.CANVAS);new Phaser.Game(Nadion.VIEW_WIDTH,Nadion.VIEW_HEIGHT,c,"#game",a)},__extends:function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},saveState:function(a,b){window.localStorage.setItem(a,JSON.stringify(b))},loadState:function(a){var b=window.localStorage.getItem(a);return b?JSON.parse(b):null},findNamedItemInArray:function(a,b){for(var c=0;c<a.length;c++)if(a[c].name&&a[c].name==b)return c;return void 0},findNamedItemInGroup:function(a,b){var c=function d(a){var c=a.cursor,e=c;do{if(e instanceof Phaser.Group)return a.cursor=c,d(e);if(e.name===b)return a.cursor=c,e;a.next(),e=a.cursor}while(e&&e!==c);return a.cursor=c,null}(a);return c},resolveTarget:function(a){if("Nadion"===a.target_name)a.target=Nadion;else if("state"===a.target_name)a.target=a.game.state.states[a.game.state.current];else if(a.target=Nadion.findNamedItemInGroup(a.game.world,a.target_name),!a.target){var b=a.game.particles.emitters[a.target_name];void 0!==b&&(a.target=b)}},wrapText:function(a,b){b=b||75;var c=".{1,"+b+"}(\\s|$)|\\S+?(\\s|$)";return a.match(RegExp(c,"g")).join("\n")}};Nadion.Controls=function(a,b,c){a.input.addPointer(),a.input.addPointer(),a.input.multiInputOverride=Phaser.Input.TOUCH_OVERRIDES_MOUSE;for(var d=a.input.pointer1,e=a.input.pointer2,f=b/c,g=[],h=0,i=0;c>i;i++){var j={left:h,right:h+f};g.push(j),h+=f}var k=[],l=[],m=function(a){return function(){var b;d.isDown&&(b=d.x);var c;return e.isDown&&(c=e.x),void 0!==b&&b>a.left&&b<a.right?1:void 0!==c&&c>a.left&&c<a.right?2:void 0}};for(i=0;c>i;i++){var n=g[i];k.push(m(n)),l.push(void 0)}var o=function(a,b,c){l[a]={callback:b,context:c}},p=function(a){for(var b=0;c>b;b++)l[b]&&a.x>g[b].left&&a.x<g[b].right&&l[b].callback.call(l[b].context)};a.input.onDown.add(p);var q=function(){var b=a.add.group();b.alpha=.33,b.visible=!0;var c=(f-64)/2,d=a.add.sprite(0,0,"button-left");d.fixedToCamera=!0,d.cameraOffset.x=g[0].left+c,d.cameraOffset.y=320,b.add(d),d=a.add.sprite(0,0,"button-right"),d.fixedToCamera=!0,d.cameraOffset.x=g[1].left+c,d.cameraOffset.y=320,b.add(d),d=a.add.sprite(0,0,"button-circle"),d.fixedToCamera=!0,d.cameraOffset.x=g[3].left+c,d.cameraOffset.y=320,b.add(d),d=a.add.sprite(0,0,"button-square"),d.fixedToCamera=!0,d.cameraOffset.x=g[4].left+c,d.cameraOffset.y=320,b.add(d)};return{buttonPressed:k,setOnPressedCallback:o,addButtons:q}},function(){function a(a){"reset"in a&&a.reset(),"revive"in a&&a.revive()}function b(a){a.is_player_sprite||a.updateObject()}Nadion.Level=function(){this.tile_width=void 0,this.tile_height=void 0,this.tilemap=void 0,this.tileset_url=void 0,this.sounds=void 0,this.background_music=void 0,this.spritesheets=void 0,this.images=void 0,this.loading_text_style=void 0,this.background_color=void 0,this.game_namespace=void 0},Nadion.Level.prototype.preload=function(){var a;for(this.game.load.tilemap("level",this.tilemap,null,Phaser.Tilemap.TILED_JSON),this.game.load.image("tiles",this.tileset_url,this.tile_width,this.tile_height),a=0;a<this.spritesheets.length;a++){var b=this.spritesheets[a];this.game.load.spritesheet(b.name,b.url,b.width,b.height)}for(a=0;a<this.images.length;a++){var c=this.images[a];this.game.load.image(c.name,c.url)}for(a=0;a<this.sounds.length;a++){var d=this.sounds[a],e=d.url+".mp3",f=d.url+".ogg";this.game.load.audio(d.name,[e,f])}this.game.pre=this.game.add.sprite(0,0,"preload"),this.game.pre.x=(Nadion.VIEW_WIDTH-this.game.pre.width)/2,this.game.pre.y=(Nadion.VIEW_HEIGHT-this.game.pre.height)/2,this.game.load.setPreloadSprite(this.game.pre),this.game.pre_text=void 0,this.loading_text_style&&(this.game.pre_text=this.game.add.bitmapText(Nadion.VIEW_WIDTH/2,Nadion.VIEW_HEIGHT/2+.2*Nadion.VIEW_HEIGHT," 0%",this.loading_text_style),this.game.pre_text.x=this.game.camera.x+(Nadion.VIEW_WIDTH-this.game.pre_text.width)/2),this.game.load.onFileComplete.removeAll(),this.game.load.onFileComplete.add(function(a){return function(b){a.pre.x=a.camera.x+(Nadion.VIEW_WIDTH-a.pre.width)/2,a.pre.y=a.camera.y+(Nadion.VIEW_HEIGHT-a.pre.height)/2,a.pre_text&&(a.pre_text.setText(b+"%"),a.pre_text.x=a.camera.x+(Nadion.VIEW_WIDTH-a.pre_text.width)/2,a.pre_text.y=a.camera.y+Nadion.VIEW_HEIGHT/2+.2*Nadion.VIEW_HEIGHT)}}(this.game))},Nadion.Level.prototype.create=function(){this.game.pre.alive=!1,this.game.pre.visible=!1,this.game.pre_text&&(this.game.pre_text.alive=!1,this.game.pre_text.visible=!1),this.showLayer1=!0,this.showLayer2=!0,this.showLayer3=!0,this.showLayer4=!0,this.showLayer5=!0,this.showFramerate=!1,this.showDebugInfo=!1,this.setupDeveloperMode(),this.game.stage.backgroundColor=this.background_color,this.background_music&&(this.music=this.game.add.audio(this.background_music.name,1,!0),this.music.play("",0,this.background_music.volume,!0)),this.paused_image_key&&(this.game.paused_image=new Phaser.Sprite(this.game,0,0,this.paused_image_key),this.game.paused_image.visible=!1,this.game.paused_image.fixedToCamera=!0,this.game.add.existing(this.game.paused_image)),this.game.onPause.add(this.onPause,this),this.game.onResume.add(this.onResume,this),this.layers=[],this.image_layers=[],this.groups=[],this.emitters=[],this.triggers=[],this.alarms=[],this.areas=[],this.setupMap(),this.setupInput(),this.game.camera.follow(this.player,Phaser.Camera.FOLLOW_PLATFORMER),this.updates=0,this.alarms.forEach(function(a){a.start()})},Nadion.Level.prototype.onPause=function(){this.game.sound.pauseAll()},Nadion.Level.prototype.onResume=function(){this.game.sound.resumeAll()},Nadion.Level.prototype.setupInput=function(){this.controls=new Nadion.Controls(this.game,Nadion.VIEW_WIDTH,5),this.game.device.desktop||this.controls.addButtons()},Nadion.Level.prototype.setupMap=function(){this.map=this.game.add.tilemap("level"),this.createLayers(),this.map.addTilesetImage("tiles","tiles");for(var a=this.game.cache.getTilemapData("level").data,b=0;b<a.tilesets.length;b++){var c,d,e=a.tilesets[b].tileproperties,f=[];for(var g in e)e.hasOwnProperty(g)&&(c=+g,isNaN(c)||(d=e[g],void 0!==d.solid&&f.push(c+1)));for(var h=0;h<this.layers.length;h++)this.layers[h].solid&&this.map.setCollision(f,!0,this.layers[h].index)}},Nadion.Level.prototype.setupDeveloperMode=function(){if(this.game.developer_mode){var a=this.game.input.keyboard.addKey(Phaser.Keyboard.ONE);a.onDown.add(function(){this.showLayer1=!this.showLayer1},this);var b=this.game.input.keyboard.addKey(Phaser.Keyboard.TWO);b.onDown.add(function(){this.showLayer2=!this.showLayer2},this);var c=this.game.input.keyboard.addKey(Phaser.Keyboard.THREE);c.onDown.add(function(){this.showLayer3=!this.showLayer3},this);var d=this.game.input.keyboard.addKey(Phaser.Keyboard.FOUR);d.onDown.add(function(){this.showLayer4=!this.showLayer4},this);var e=this.game.input.keyboard.addKey(Phaser.Keyboard.FIVE);e.onDown.add(function(){this.showLayer5=!this.showLayer5},this);var f=this.game.input.keyboard.addKey(Phaser.Keyboard.F);f.onDown.add(function(){this.showFramerate=!this.showFramerate},this);var g=this.game.input.keyboard.addKey(Phaser.Keyboard.P);g.onDown.add(function(){for(var a=0;a<this.emitters.length;a++)this.emitters[a].alive?this.emitters[a].kill():(this.emitters[a].revive(),this.emitters[a].go())},this);var h=this.game.input.keyboard.addKey(Phaser.Keyboard.D);h.onDown.add(function(){this.showDebugInfo=!this.showDebugInfo},this)}},Nadion.Level.prototype.createLayers=function(){var a=this.game.cache.getTilemapData("level").data;if(!a.properties.width||!a.properties.height)throw console.error("Tiled map data must set 'width' and 'height' properties on the map object!"),new Error("Tiled map error: no width/height properties on map");this.world_width=a.properties.width,this.world_height=a.properties.height;for(var b=a.layers,c=0,d=0;d<b.length;d++){var e=b[d];switch(e.type){case"tilelayer":(!this.game.excluded_layers||this.game.excluded_layers&&-1===this.game.excluded_layers.indexOf(e.name))&&this.createTileLayer(e,c),c++;break;case"objectgroup":this.createObjects(e);break;case"imagelayer":this.createImageLayer(e);break;default:console.warn("Unknown layer type '"+e.type+"'in Tiled map file")}}var f=a.properties.main_layer||"main";if(this.main_layer_index=Nadion.findNamedItemInArray(this.layers,f,this.main_layer_index),void 0===this.main_layer_index)throw new Error("No 'main' layer in Tiled map!");if(this.main_layer=this.layers[this.main_layer_index],this.main_layer.resizeWorld(),this.game.world.setBounds(0,0,this.world_width,this.world_height),!this.player)throw new Error("No 'player' sprite in Tiled map!");this.player.group.visible||(this.player.group.visible=!0)},Nadion.Level.prototype.createTileLayer=function(a,b){var c=+(a.properties&&a.properties.scrollFactorX||1),d=+(a.properties&&a.properties.scrollFactorY||1),e=this.map.createLayer(b);e.name=a.name,e.solid=void 0!==a.properties&&("true"==a.properties.solid?!0:!1),e.visible=a.visible,e.scrollFactorX=c,e.scrollFactorY=d,this.layers.push(e)},Nadion.Level.prototype.createImageLayer=function(a){var b=this.game.add.sprite(0,0,a.name);b.name=a.name;var c=0,d=0,e=this.world_width,f=this.world_height,g=e-Nadion.VIEW_WIDTH,h=f-Nadion.VIEW_HEIGHT;0!==g&&(c=(b.width-Nadion.VIEW_WIDTH)/g),0!==h&&(d=(b.height-Nadion.VIEW_HEIGHT)/h),b.update=function(){this.x=this.game.camera.view.x-this.game.camera.view.x*c,this.y=this.game.camera.view.y-this.game.camera.view.y*d},b.imageLayer=!0,this.image_layers.push(b)},Nadion.Level.prototype.createObjects=function(a){var b=a,c=this.game.add.group();c.name=b.name||"",c.visible=void 0===b.visible?!0:b.visible,c.alpha=+b.opacity||1;for(var d=0;d<b.objects.length;d++){var e,f=b.objects[d];if(this.game_namespace&&(e=this.game_namespace[f.type]),e||(e=Nadion[f.type]),e||(e=window[f.type]),!e)throw new Error("Unable to create Object: '"+f.type+"'");var g=new e(this.game,f.name,f.x,f.y,f.width,f.height,f.properties);"undefined"!=typeof g&&null!==g&&(g.is_player_sprite&&(this.player=g),g instanceof Phaser.Sprite?c.add(g):g instanceof Phaser.Particles.Arcade.Emitter?this.emitters.push(g):g instanceof Nadion.Trigger?this.triggers.push(g):g instanceof Nadion.Alarm?this.alarms.push(g):g instanceof Nadion.Area&&this.areas.push(g))}c.exists=!1,this.groups.push(c)},Nadion.Level.prototype.restart=function(){this.updates=0,this.game.sound.stopAll();for(var b=0;b<this.groups.length;b++)this.groups[b].forEach(a),this.groups[b].exists=!1;this.triggers.forEach(a),this.alarms.forEach(a),this.areas.forEach(a),this.emitters.forEach(a),this.background_music&&this.music.play("",0,this.background_music.volume,!0)},Nadion.Level.prototype.update=function(){if(0===this.updates)for(this.updates++,a=0;a<this.groups.length;a++)this.groups[a].exists=!0;for(var a=0;a<this.layers.length;a++){var c="showLayer"+(a+1);this[c]?"collision"!==this.layers[a].name&&(this.layers[a].visible=!0):this.layers[a].visible=!1}for(this.player.updateObject(),a=0;a<this.groups.length;a++)this.groups[a].forEachAlive(b);this.triggers.forEach(b),this.alarms.forEach(b),this.areas.forEach(b),this.emitters.forEach(b);var d=this.triggers.length;for(a=0;d>a;a++){var e=this.triggers[a];e.trigger_on_touch&&e.checkActivate.call(e)}},Nadion.Level.prototype.render=function(){this.game.paused&&this.game.paused_image?(this.game.paused_image.visible=!0,this.game.paused_image.bringToTop()):this.game.paused_image&&(this.game.paused_image.visible=!1),this.showFramerate&&this.game.debug.renderText(this.game.time.fps,10,25,"#ff0000"),this.showDebugInfo&&(this.game.debug.renderSpriteBody(this.player,"rgba(0,255,0,0.3)"),this.game.debug.renderSpriteCorners(this.player),this.game.world.forEach(function(a){!(a instanceof Phaser.Sprite)||a instanceof Phaser.TileSprite||a instanceof Phaser.TilemapLayer||!a.alive||!a.visible||a.imageLayer||(this.game.debug.renderSpriteBody(a),this.game.debug.renderSpriteCorners(a))},this))}}(),Nadion.StateMachine=function(a,b){this.states=a,this.receiver=b,this.indices={},this.initialState=void 0;for(var c=0;c<a.length;c++)this.indices[this.states[c].name]=c,this.states[c].initial&&(this.initialState=this.states[c]);this.initialState||console.warn("State Machine has no initial state!"),this.currentState=this.initialState},Nadion.StateMachine.prototype.consumeEvent=function(a){this.currentState.events[a]?(this.currentState=this.states[this.indices[this.currentState.events[a]]],this.receiver[this.currentState.name].call(this.receiver)):console.warn("State Machine called with invalid event: '"+a+"' for current state: '"+this.currentState.name+"'.")},Nadion.StateMachine.prototype.getState=function(){return this.currentState.name},Nadion.StateMachine.prototype.reset=function(){this.currentState=this.initialState},function(){Nadion.BaseSprite=function(a,b,c,d,e,f,g,h){if(d+=.5*f,e+=.5*g,Phaser.Sprite.call(this,a,d,e,b),this.name=c||"",this.initial_x=d,this.initial_y=e,this.is_player_sprite=!1,this.anchor.x=.5,this.anchor.y=.5,this.x=this.initial_x,this.y=this.initial_y,h)for(var i in h)h.hasOwnProperty(i)&&"name"!==i&&"initial_x"!==i&&"initial_y"!==i&&(this[i]=h[i]);a.add.existing(this)},Nadion.BaseSprite.prototype=Object.create(Phaser.Sprite),Nadion.__extends(Nadion.BaseSprite,Phaser.Sprite),Nadion.BaseSprite.prototype.constructor=Nadion.BaseSprite,Nadion.BaseSprite.prototype.reset=function(){Phaser.Sprite.prototype.reset.call(this,this.initial_x,this.initial_y),Phaser.Sprite.prototype.updateCache.call(this)},Nadion.Trigger=function(a,b,c,d,e,f,g){this.game=a,this.name=b,this.x=c,this.y=d,this.width=e||1,this.height=f||1,this.props=g||{},this.entity_name=g.entity,this.target_name=g.target||null,this.on_callback=g.on,this.off_callback=g.off||null,this.type=g.type||"Trigger",this.trigger_on_touch="true"===g.trigger_on_touch,this.activated=!1,this.exists=!0,this.body={x:this.x,y:this.y,right:this.x+this.width,bottom:this.y+this.height}},Nadion.Trigger.prototype.reset=function(){this.deactivate()},Nadion.Trigger.prototype.updateObject=function(){this.target_name&&!this.target&&Nadion.resolveTarget(this),this.entity_name&&!this.entity&&(this.entity=Nadion.findNamedItemInGroup(this.game.world,this.entity_name)),this.activated},Nadion.Trigger.prototype.activate=function(){return this.activated?!1:(this.activated=!0,this.on&&this.on instanceof Function?this.on(this,this.entity):this.on_callback&&this.target[this.on_callback]instanceof Function?this.target[this.on_callback](this,this.entity):!0)},Nadion.Trigger.prototype.deactivate=function(){return this.activated?(this.activated=!1,this.off&&this.off instanceof Function?this.off(this,this.entity):this.off_callback&&this.target[this.off_callback]instanceof Function?this.target[this.off_callback](this,this.entity):!0):!1},Nadion.Trigger.prototype.check=function(){return Phaser.Rectangle.intersects(this.body,this.entity.body)},Nadion.Trigger.prototype.checkActivate=function(){return this.check()?this.activate():void 0},Nadion.Trigger.prototype.checkDeactivate=function(){return this.check()?this.deactivate():void 0},Nadion.SetTileTrigger=function(a,b,c,d,e,f,g){Nadion.Trigger.call(this,a,b,c,d,e,f,g),this.game=a,this.game_state=a.state.states[a.state.current],this.map=this.game_state.map,this.old_trigger_tile=void 0,this.new_tile_data=[],this.tiles_saved=!1;var h=this.game.cache.getTilemapData("level").data,i=h.tilesets[0].tileproperties,j=g.new_tile_1,k=JSON.parse(j);i[k.tile]&&i[k.tile].solid&&(k.solid=!0),this.new_tile_data.push(k),"new_tile_2"in g&&(j=g.new_tile_2,k=JSON.parse(j),i[k.tile]&&i[k.tile].solid&&(k.solid=!0),this.new_tile_data.push(k)),"new_tile_3"in g&&(j=g.new_tile_3,k=JSON.parse(j),i[k.tile]&&i[k.tile].solid&&(k.solid=!0),this.new_tile_data.push(k)),this.new_trigger_tile=void 0,"new_trigger_tile"in g&&(this.new_trigger_tile=+g.new_trigger_tile),this.trigger_tile_x=void 0,this.trigger_tile_y=void 0,this.sound_effect=g.sound_effect,this.sound_effect&&(this.noise=a.add.audio(this.sound_effect,1,!0)),this.volume=1,"volume"in g&&(this.volume=+g.volume),g.on="on",g.off="off",this.target=this},Nadion.SetTileTrigger.prototype=Object.create(Nadion.Trigger),Nadion.__extends(Nadion.SetTileTrigger,Nadion.Trigger),Nadion.SetTileTrigger.prototype.constructor=Nadion.SetTileTrigger,Nadion.SetTileTrigger.prototype.reset=function(){if(this.activated=!1,this.tiles_saved){for(var a=0;a<this.new_tile_data.length;a++){var b=Nadion.findNamedItemInArray(this.game_state.layers,this.new_tile_data[a].layer),c=+this.new_tile_data[a].x,d=+this.new_tile_data[a].y,e=+this.new_tile_data[a].old_tile;this.map.putTile(e,c,d,b)}this.map.putTile(this.old_trigger_tile,this.trigger_tile_x,this.trigger_tile_y,this.game_state.main_layer_index)}},Nadion.SetTileTrigger.prototype.on=function(){var a,b,c,d,e;if(void 0===this.old_trigger_tile){for(a=0;a<this.new_tile_data.length;a++)b=Nadion.findNamedItemInArray(this.game_state.layers,this.new_tile_data[a].layer),d=+this.new_tile_data[a].x,e=+this.new_tile_data[a].y,c=this.map.getTile(d,e,b),c&&(this.new_tile_data[a].old_tile=c);this.tiles_saved=!0}for(void 0!==this.new_trigger_tile&&void 0===this.old_trigger_tile&&(this.trigger_tile_x=this.game.math.snapToFloor(this.x,this.map.tileWidth)/this.map.tileWidth,this.trigger_tile_y=this.game.math.snapToFloor(this.y,this.map.tileHeight)/this.map.tileHeight,c=this.map.getTile(this.trigger_tile_x,this.trigger_tile_y,this.game_state.main_layer_index),c&&(this.old_trigger_tile=c)),a=0;a<this.new_tile_data.length;a++){b=Nadion.findNamedItemInArray(this.game_state.layers,this.new_tile_data[a].layer),d=+this.new_tile_data[a].x,e=+this.new_tile_data[a].y;var f=this.new_tile_data[a].old_tile;f.index=+this.new_tile_data[a].tile,this.new_tile_data[a].solid?(f.collides=!0,f.faceTop=!0,f.faceBottom=!0,f.faceLeft=!0,f.faceRight=!0):(f.collides=!1,f.faceTop=!1,f.faceBottom=!1,f.faceLeft=!1,f.faceRight=!1),this.map.putTile(f,d,e,b)}return this.new_trigger_tile&&this.map.putTile(this.new_trigger_tile,this.trigger_tile_x,this.trigger_tile_y,this.game_state.main_layer_index),this.noise&&this.noise.play("",0,this.volume),this.map.game.camera.x++,this.map.game.camera.x--,!0},Nadion.SetTileTrigger.prototype.off=function(){for(var a=0;a<this.new_tile_data.length;a++){var b=Nadion.findNamedItemInArray(this.game_state.layers,this.new_tile_data[a].layer),c=+this.new_tile_data[a].x,d=+this.new_tile_data[a].y,e=+this.new_tile_data[a].old_tile;this.map.putTile(e,c,d,b)}return this.new_trigger_tile&&this.map.putTile(this.old_trigger_tile,this.trigger_tile_x,this.trigger_tile_y,this.game_state.main_layer_index),this.noise&&this.noise.play("",0,.5),this.map.game.camera.x+=4,this.map.game.camera.x-=4,!0},Nadion.NextLevelTrigger=function(a,b,c,d,e,f,g){Nadion.Trigger.call(this,a,b,c,d,e,f,g),this.level=+g.level,this.state=a.state,this.fade_color=0,this.one_alpha={alpha:1},this.bg=this.game.add.graphics(0,0),this.bg.alive=!1,g.on="on",void 0===g.trigger_on_touch&&(this.trigger_on_touch=!0)},Nadion.NextLevelTrigger.prototype=Object.create(Nadion.Trigger),Nadion.__extends(Nadion.NextLevelTrigger,Nadion.Trigger),Nadion.NextLevelTrigger.prototype.constructor=Nadion.NextLevelTrigger,Nadion.NextLevelTrigger.prototype.fadeOut=function(){this.bg.beginFill(this.fade_color,1);var a=this.game.camera.x+this.game.stage.bounds.width/2,b=this.game.camera.y+this.game.stage.bounds.height/2,c=1.25*Nadion.VIEW_WIDTH,d=1.25*Nadion.VIEW_HEIGHT;this.bg.drawRect(a-c/2,b-d/2,c,d),this.bg.alpha=0,this.bg.endFill(),this.bg.alive=!0,this.bg.group.bringToTop(this.bg);var e=this.game.add.tween(this.bg);e.to(this.one_alpha,1e3,null),e.onComplete.addOnce(this.changeState,this),e.start()},Nadion.NextLevelTrigger.prototype.changeState=function(){this.state.game.sound.stopAll(),this.game.context&&this.game.context.clearRect(0,0,this.game.canvas.width,this.game.canvas.height);var a={level:this.level};Nadion.saveState(a);var b,c=this.state.states[this.state.current];c.game_namespace&&(b=c.game_namespace["Level_"+this.level]),b||(b=Nadion["Level_"+this.level]),b||(b=window["Level_"+this.level]),b||console.error("Can't create level for NextLevelTrigger"),this.state.add("level-"+this.level,b,!1),this.state.start("level-"+this.level,!0,!0),this.state.remove(c.key),this.bg.alive=!1},Nadion.NextLevelTrigger.prototype.on=function(){return this.fadeOut(),!0},Nadion.TeleportTrigger=function(a,b,c,d,e,f,g){Nadion.Trigger.call(this,a,b,c,d,e,f,g),this.new_x=+g.new_x,this.new_y=+g.new_y,g.on="on",void 0===g.trigger_on_touch&&(this.trigger_on_touch=!0)},Nadion.TeleportTrigger.prototype=Object.create(Nadion.Trigger),Nadion.__extends(Nadion.TeleportTrigger,Nadion.Trigger),Nadion.TeleportTrigger.prototype.constructor=Nadion.TeleportTrigger,Nadion.TeleportTrigger.prototype.on=function(){return this.entity.x=this.new_x,this.entity.y=this.new_y,this.activated=!1,!0},Nadion.ResetLevelTrigger=function(a,b,c,d,e,f,g){Nadion.Trigger.call(this,a,b,c,d,e,f,g),this.activated_time=0,this.fade_color=0,this.one_alpha={alpha:1},this.bg=this.game.add.graphics(0,0),this.bg.alive=!1,this.state=a.state.states[a.state.current],void 0===g.trigger_on_touch&&(this.trigger_on_touch=!0)},Nadion.ResetLevelTrigger.prototype=Object.create(Nadion.Trigger),Nadion.__extends(Nadion.ResetLevelTrigger,Nadion.Trigger),Nadion.ResetLevelTrigger.prototype.constructor=Nadion.ResetLevelTrigger,Nadion.ResetLevelTrigger.prototype.reset=function(){},Nadion.ResetLevelTrigger.prototype.fadeOut=function(){this.bg.beginFill(this.fade_color,1);var a=this.game.camera.x+this.game.stage.bounds.width/2,b=this.game.camera.y+this.game.stage.bounds.height/2,c=1.25*Nadion.VIEW_WIDTH,d=1.25*Nadion.VIEW_HEIGHT;this.bg.drawRect(a-c/2,b-d/2,c,d),this.bg.alpha=0,this.bg.endFill(),this.bg.alive=!0,this.bg.visible=!0,this.bg.group.bringToTop(this.bg);var e=this.game.add.tween(this.bg);e.to(this.one_alpha,1e3,null),e.onComplete.addOnce(this.resetLevel,this),e.start()},Nadion.ResetLevelTrigger.prototype.resetLevel=function(){this.state.restart(),this.bg.alive=!1,this.bg.visible=!1},Nadion.ResetLevelTrigger.prototype.on=function(){return this.activated_time=this.game.time.now,this.state.player&&(this.state.player.body.velocity.x=0,this.state.player.body.velocity.y=0,this.state.player.exists=!1),this.fadeOut(),!0},Nadion.ResetLevelTrigger.prototype.updateObject=function(){Nadion.Trigger.prototype.updateObject.call(this),this.activated&&0!==this.activated_time&&this.game.time.elapsedSince(this.activated_time)>=1500&&(this.activated=!1,this.activated_time=0)},Nadion.Emitter=function(a,b,c,d,e,f,g){if(a.use_particle_effects===!1)return null;var h=new Phaser.Particles.Arcade.Emitter(a,0,0,+g.quantity);h.name=b,a.particles.add(h);var i=c,j=d;h.x=i+e/2,h.y=j+f/2,h.height=f,h.width=e,h.period=+(g.period||0),h.delay=+(g.delay||0);var k=g.image;k||console.error("No image property on Nadion.Emitter object in level json!");var l=g.frames||"0";l=l.split(",");for(var m=0;m<l.length;m++)l[m]=+l[m];return h.makeParticles(k,l),h.minParticleSpeed.x=+(g.minParticleSpeedX||0),h.minParticleSpeed.y=+(g.minParticleSpeedY||0),h.maxParticleSpeed.x=+(g.maxParticleSpeedX||0),h.maxParticleSpeed.y=+(g.maxParticleSpeedY||0),h.minRotation=+(g.minRotation||0),h.maxRotation=+(g.maxRotation||0),h.gravity=+(g.gravity||0),"true"===g.autostart&&h.start(!1,h.period,h.delay),h.constrained="true"===g.constrained,h.constrained?(h._orig_rect=new Phaser.Rectangle(i,j,h.width,h.height),h._rect=new Phaser.Rectangle,h._new_rect=new Phaser.Rectangle,h.updateObject=function(){this._rect.x=this.game.camera.x,this._rect.y=this.game.camera.y,this._rect.width=this.game.camera.width,this._rect.height=this.game.camera.height,Phaser.Rectangle.intersection(this._rect,this._orig_rect,this._new_rect),this.x=this._new_rect.x+this._new_rect.width/2,this.y=this._new_rect.y+this._new_rect.height/2,this.height=this._new_rect.height,this.width=this._new_rect.width}):h.updateObject=function(){},h.reset=function(){this.kill(),"true"===g.autostart&&h.start(!1,h.period,h.delay)},h.go=function(){return this.start(!1,this.period,this.delay),!0},h.stop=function(){return this.kill(),!0},h},Nadion.Alarm=function(a,b,c,d,e,f,g){this.game=a,this.name=b,this.x=c||0,this.y=d||0,this.width=e||1,this.height=f||1,this.props=g||{},this.target_name=g.target||null,this.period=g.period||0,this.call=g.call||null,this.repeating=g.repeating||!1,this.type=g.type||"Alarm",this.activated=!1,this.started=!1,this.start_time=0,this.exists=!0,this.body={x:this.x,y:this.y,right:this.x+this.width,bottom:this.y+this.height}},Nadion.Alarm.prototype.reset=function(){this.activated=!1,this.started=!1,this.start_time=0},Nadion.Alarm.prototype.updateObject=function(){this.target_name&&!this.target&&Nadion.resolveTarget(this),this.started&&this.game.time.elapsedSince(this.start_time)>=this.period&&(this.target&&(this.call&&this.target[this.call]instanceof Function?this.target[this.call](this):this.target.alarm instanceof Function&&this.target.alarm(this)),this.repeating?this.start_time=this.game.time.time:this.started=!1)},Nadion.Alarm.prototype.start=function(){this.started||(this.started=!0,this.start_time=this.game.time.time)},Nadion.Area=function(a,b,c,d,e,f,g){this.game=a,this.name=b,this.x=c,this.y=d,this.width=e||1,this.height=f||1,this.props=g||{},this.entity_name=g.entity,this.target_name=g.target||null,this.on_enter=g.on_enter,this.on_exit=g.on_exit,this.type=g.type||"Area",this.entity_inside=!1,this.exists=!0,this.body={x:this.x,y:this.y,right:this.x+this.width,bottom:this.y+this.height}},Nadion.Area.prototype.updateObject=function(){this.target_name&&!this.target&&Nadion.resolveTarget(this),this.entity_name&&!this.entity&&(this.entity=Nadion.findNamedItemInGroup(this.game.world,this.entity_name));var a=Phaser.Rectangle.intersects(this.body,this.entity.body);a&&!this.entity_inside?(this.entity_inside=!0,this.on_enter&&this.target[this.on_enter]instanceof Function&&this.target[this.on_enter](this)):!a&&this.entity_inside&&(this.entity_inside=!1,this.on_exit&&this.target[this.on_exit]instanceof Function&&this.target[this.on_exit](this))}}();